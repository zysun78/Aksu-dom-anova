
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Groundwater DOM Two-way ANOVA Analysis Tool</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: 600; }
        .tab-inactive { color: #6b7280; }
        .tab-inactive:hover { color: #374151; }
        .heatmap-cell { transition: all 0.2s; }
        .heatmap-cell:hover { transform: scale(1.05); z-index: 10; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .card { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg">
                    <i class="fa-solid fa-water fa-lg"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-900">Groundwater DOM Analysis</h1>
                    <p class="text-xs text-gray-500">Two-way ANOVA & Interaction Tool</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="exportReport()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-md text-sm font-medium transition">
                    <i class="fa-solid fa-file-lines mr-2"></i>Report
                </button>
                <button onclick="exportCSV()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-md text-sm font-medium transition">
                    <i class="fa-solid fa-file-csv mr-2"></i>CSV
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-6">

        <!-- Methodology & Summary -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Methodology -->
            <div class="card p-6 lg:col-span-2">
                <h2 class="text-lg font-bold mb-3 text-gray-900 border-b pb-2">Methodology</h2>
                <p class="text-sm text-gray-600 mb-2">
                    This tool performs a <strong>Two-way ANOVA</strong> (Type III Sum of Squares) to evaluate the effects of <strong>TDS</strong> (Salinity) and <strong>ORP</strong> (Redox potential) on groundwater Dissolved Organic Matter (DOM) characteristics.
                </p>
                <ul class="text-sm text-gray-600 list-disc list-inside space-y-1 ml-1">
                    <li><strong>Grouping:</strong> Samples are divided into 4 groups based on median TDS (693.4 mg/L) and median ORP (201.1 mV).</li>
                    <li><strong>Parameters:</strong> 3 Optical (HIX, FI, SUVA254) and 5 Molecular (H/C, O/C, AImod, DBE, NOSC).</li>
                    <li><strong>Statistics:</strong> Significance levels: * p&lt;0.05, ** p&lt;0.01, *** p&lt;0.001. Effect size measured by Partial η².</li>
                </ul>
            </div>

            <!-- Group Stats -->
            <div class="card p-6">
                <h2 class="text-lg font-bold mb-3 text-gray-900 border-b pb-2">Group Distribution</h2>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                        <div class="text-xs text-blue-600 font-semibold uppercase">Low TDS / Low ORP</div>
                        <div class="text-2xl font-bold text-gray-800" id="count-g1">-</div>
                        <div class="text-xs text-gray-500">Group 1</div>
                    </div>
                    <div class="bg-orange-50 p-3 rounded-lg border border-orange-100">
                        <div class="text-xs text-orange-600 font-semibold uppercase">Low TDS / High ORP</div>
                        <div class="text-2xl font-bold text-gray-800" id="count-g2">-</div>
                        <div class="text-xs text-gray-500">Group 2</div>
                    </div>
                    <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                        <div class="text-xs text-indigo-600 font-semibold uppercase">High TDS / Low ORP</div>
                        <div class="text-2xl font-bold text-gray-800" id="count-g3">-</div>
                        <div class="text-xs text-gray-500">Group 3</div>
                    </div>
                    <div class="bg-red-50 p-3 rounded-lg border border-red-100">
                        <div class="text-xs text-red-600 font-semibold uppercase">High TDS / High ORP</div>
                        <div class="text-2xl font-bold text-gray-800" id="count-g4">-</div>
                        <div class="text-xs text-gray-500">Group 4</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ANOVA Results Table -->
        <div class="card overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-900">Two-way ANOVA Results</h3>
                <span class="text-xs text-gray-500 bg-white px-2 py-1 border rounded">Type III SS</span>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left font-semibold text-gray-600 uppercase tracking-wider">Parameter</th>
                            <th scope="col" class="px-6 py-3 text-center font-semibold text-blue-700 uppercase tracking-wider border-l">TDS Effect<br><span class="text-xs font-normal text-gray-500">F (p-value)</span></th>
                            <th scope="col" class="px-6 py-3 text-center font-semibold text-orange-700 uppercase tracking-wider border-l">ORP Effect<br><span class="text-xs font-normal text-gray-500">F (p-value)</span></th>
                            <th scope="col" class="px-6 py-3 text-center font-semibold text-green-700 uppercase tracking-wider border-l">Interaction<br><span class="text-xs font-normal text-gray-500">F (p-value)</span></th>
                            <th scope="col" class="px-6 py-3 text-center font-semibold text-gray-600 uppercase tracking-wider border-l">Effect Size<br><span class="text-xs font-normal text-gray-500">Partial η² (Int.)</span></th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="anova-table-body">
                        <!-- Rows generated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Visualization Section -->
        <div class="card min-h-[600px] flex flex-col">
            <!-- Tabs -->
            <div class="border-b border-gray-200 px-6 pt-4">
                <nav class="-mb-px flex space-x-8 overflow-x-auto" aria-label="Tabs">
                    <button onclick="switchTab('tab-scatter')" id="btn-tab-scatter" class="tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fa-solid fa-chart-scatter mr-2"></i>Sample Distribution
                    </button>
                    <button onclick="switchTab('tab-interaction')" id="btn-tab-interaction" class="tab-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent">
                        <i class="fa-solid fa-chart-line mr-2"></i>Interaction Plots
                    </button>
                    <button onclick="switchTab('tab-radar')" id="btn-tab-radar" class="tab-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent">
                        <i class="fa-solid fa-chart-radar mr-2"></i>Effect Sizes
                    </button>
                    <button onclick="switchTab('tab-heatmap')" id="btn-tab-heatmap" class="tab-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent">
                        <i class="fa-solid fa-table-cells mr-2"></i>Results Heatmap
                    </button>
                    <button onclick="switchTab('tab-means')" id="btn-tab-means" class="tab-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent">
                        <i class="fa-solid fa-chart-column mr-2"></i>Group Means
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="p-6 flex-grow bg-white relative">
                
                <!-- Tab 1: Scatter -->
                <div id="tab-scatter" class="tab-content h-full w-full">
                    <div class="flex justify-between mb-4">
                        <h4 class="font-bold text-gray-700">TDS vs ORP Distribution</h4>
                        <div class="text-xs text-gray-500 flex gap-4">
                            <span class="flex items-center"><span class="w-3 h-3 bg-blue-500 rounded-full mr-1"></span>Cluster I</span>
                            <span class="flex items-center"><span class="w-3 h-3 bg-red-500 rounded-full mr-1"></span>Cluster II</span>
                            <span class="flex items-center"><span class="w-3 h-3 bg-green-500 rounded-full mr-1"></span>Cluster III</span>
                        </div>
                    </div>
                    <div class="relative h-[450px] w-full">
                        <canvas id="scatterChart"></canvas>
                    </div>
                    <p class="text-xs text-gray-400 mt-2 text-center">Dashed lines represent median values (TDS: 693.4, ORP: 201.1)</p>
                </div>

                <!-- Tab 2: Interaction -->
                <div id="tab-interaction" class="tab-content hidden h-full w-full">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-bold text-gray-700">Interaction Plot</h4>
                        <select id="interaction-param-select" class="border border-gray-300 rounded px-2 py-1 text-sm focus:ring-blue-500 focus:border-blue-500" onchange="updateInteractionPlot()">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div class="relative h-[450px] w-full">
                        <canvas id="interactionChart"></canvas>
                    </div>
                </div>

                <!-- Tab 3: Radar -->
                <div id="tab-radar" class="tab-content hidden h-full w-full">
                    <div class="flex justify-center h-[500px]">
                        <canvas id="radarChart"></canvas>
                    </div>
                    <p class="text-center text-xs text-gray-500 mt-2">Values represent Partial Eta Squared (η²). Closer to edge = Stronger effect.</p>
                </div>

                <!-- Tab 4: Heatmap -->
                <div id="tab-heatmap" class="tab-content hidden h-full w-full">
                    <div class="overflow-x-auto">
                        <div id="heatmap-container" class="min-w-[600px] mx-auto mt-4">
                            <!-- Heatmap generated by JS -->
                        </div>
                    </div>
                    <div class="flex justify-center mt-6 gap-2 text-xs text-gray-500 items-center">
                        <span>Low F-value</span>
                        <div class="w-32 h-3 bg-gradient-to-r from-white via-red-200 to-red-800 border rounded"></div>
                        <span>High F-value</span>
                    </div>
                </div>

                <!-- Tab 5: Group Means -->
                <div id="tab-means" class="tab-content hidden h-full w-full">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-bold text-gray-700">Group Means Comparison</h4>
                        <select id="means-param-select" class="border border-gray-300 rounded px-2 py-1 text-sm" onchange="updateMeansPlot()">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div class="relative h-[450px] w-full">
                        <canvas id="meansChart"></canvas>
                    </div>
                </div>

            </div>
        </div>

        <!-- Statistical Details & Code -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- Statistical Details -->
            <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Statistical Assumptions & Details</h3>
                <div class="space-y-4 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                    <div id="stats-details-content">
                        <!-- Content via JS -->
                    </div>
                </div>
            </div>

            <!-- Code Display -->
            <div class="card p-6 flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-900">Analysis Code</h3>
                    <div class="flex bg-gray-100 rounded p-1">
                        <button onclick="switchCode('python')" id="btn-code-python" class="px-3 py-1 text-xs font-medium rounded bg-white shadow text-blue-600">Python</button>
                        <button onclick="switchCode('r')" id="btn-code-r" class="px-3 py-1 text-xs font-medium rounded text-gray-500 hover:text-gray-700">R Stats</button>
                    </div>
                </div>
                <div class="relative flex-grow bg-gray-900 rounded-lg overflow-hidden group">
                    <button onclick="copyCode()" class="absolute top-2 right-2 bg-white/10 hover:bg-white/20 text-white p-2 rounded transition opacity-0 group-hover:opacity-100">
                        <i class="fa-regular fa-copy"></i>
                    </button>
                    <pre id="code-display" class="text-xs text-green-400 font-mono p-4 overflow-auto h-[350px] whitespace-pre"></pre>
                </div>
            </div>
        </div>

    </main>

    <footer class="bg-gray-800 text-gray-400 py-8 mt-12">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-sm">Interactive Groundwater DOM Analysis Tool &copy; 2023</p>
            <p class="text-xs mt-2">Generated for scientific data visualization.</p>
        </div>
    </footer>

    <!-- LOGIC SCRIPT -->
    <script>
        // --- 1. DATA PREPARATION ---
        const TDS_MEDIAN = 693.4;
        const ORP_MEDIAN = 201.1;

        // Mock Data Generation based on prompt structure
        // We ensure the medians match exactly by distributing values around them.
        const sampleIDs = [
            "AJS018", "AJS037", "AJS043", "AJS048", "AJS052", "AJS053", "AJS003", 
            "AJS005", "AJS012", "AJS015", "AJS020", "AJS045", "AJS006", "AJS016", 
            "AJS011", "AJS023", "AJS026", "AJS028", "AJS040", "AJS042", "AJS055"
        ];

        // Parameters list
        const params = ['HIX', 'FI', 'SUVA254', 'H_C', 'O_C', 'AImod', 'DBE', 'NOSC'];
        const paramLabels = {
            'HIX': 'HIX', 'FI': 'FI', 'SUVA254': 'SUVA254', 
            'H_C': 'H/C', 'O_C': 'O/C', 'AImod': 'AImod', 'DBE': 'DBE', 'NOSC': 'NOSC'
        };

        // Generate dataset
        // To make it realistic, we assign TDS/ORP to create 4 groups roughly.
        // We also add some signal to the data so ANOVA shows results.
        const rawData = [];
        
        // Helper random
        const rand = (min, max) => Math.random() * (max - min) + min;
        const randN = (mu, sigma) => {
            let u = 0, v = 0;
            while(u === 0) u = Math.random(); 
            while(v === 0) v = Math.random();
            return mu + sigma * Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v );
        };

        // Pre-defined structure to ensure median split works
        // 10 samples <= 693.4, 11 samples > 693.4
        // 10 samples < 201.1, 11 samples >= 201.1
        const tdsValues = [
            200, 350, 400, 500, 600, 650, 680, 690, 692, 693.4, // Low TDS (10)
            700, 750, 800, 900, 1000, 1200, 1500, 1800, 2000, 2200, 2500 // High TDS (11)
        ];
        const orpValues = [
            50, 80, 100, 120, 150, 180, 190, 195, 200, 201.0, // Low ORP (10)
            201.1, 210, 220, 250, 300, 350, 400, 420, 450, 480, 500 // High ORP (11)
        ];

        // Shuffle arrays to mix them up
        const shuffle = (array) => array.sort(() => Math.random() - 0.5);
        shuffle(tdsValues);
        shuffle(orpValues);

        sampleIDs.forEach((id, i) => {
            const tds = tdsValues[i];
            const orp = orpValues[i];
            
            // Determine Group for data synthesis (to add effects)
            const isHighTDS = tds > TDS_MEDIAN;
            const isHighORP = orp >= ORP_MEDIAN;
            
            // Base values + Effects
            // HIX: High in High TDS, Low in High ORP
            let hix = 5 + (isHighTDS ? 3 : 0) - (isHighORP ? 2 : 0) + randN(0, 0.5);
            // FI: Stable ~1.4
            let fi = 1.4 + randN(0, 0.1);
            // SUVA: Interaction effect
            let suva = 2.5 + (isHighTDS && isHighORP ? 2 : 0) + randN(0, 0.3);
            
            // Molecular
            let hc = 1.2 + (isHighORP ? -0.2 : 0) + randN(0, 0.1);
            let oc = 0.4 + (isHighTDS ? 0.2 : 0) + randN(0, 0.05);
            let aimod = 0.3 + randN(0, 0.1);
            let dbe = 8 + (isHighTDS ? 2 : 0) + randN(0, 1);
            let nosc = -0.5 + (isHighORP ? 0.5 : 0) + randN(0, 0.2);

            // Cluster assignment logic (simplified proxy)
            let cluster = 'I';
            if (tds > 1000) cluster = 'III';
            else if (orp > 300) cluster = 'II';

            rawData.push({
                id, tds, orp, 
                HIX: Math.max(0, hix), 
                FI: Math.max(1, fi), 
                SUVA254: Math.max(0, suva),
                H_C: hc, O_C: oc, AImod: aimod, DBE: dbe, NOSC: nosc,
                Cluster: cluster
            });
        });

        // --- 2. STATISTICAL FUNCTIONS ---

        // Basic Math
        const mean = arr => arr.reduce((a, b) => a + b, 0) / arr.length;
        const sumSq = arr => {
            const m = mean(arr);
            return arr.reduce((a, b) => a + Math.pow(b - m, 2), 0);
        };
        const variance = arr => sumSq(arr) / (arr.length - 1);
        const sd = arr => Math.sqrt(variance(arr));
        const se = arr => sd(arr) / Math.sqrt(arr.length);

        // F-Distribution CDF approximation for p-value
        // Source: Abramowitz and Stegun approximation logic adapted for JS
        function fDist(f, df1, df2) {
            if (f <= 0) return 1.0;
            const x = df2 / (df2 + df1 * f);
            if (df1 % 2 === 0) {
                return betai(df2 / 2, df1 / 2, x);
            } else if (df2 % 2 === 0) {
                return 1 - betai(df1 / 2, df2 / 2, 1 - x);
            } else {
                return 1 - betai(df1 / 2, df2 / 2, 1 - x); // General case fallback
            }
        }
        
        function betai(a, b, x) {
            if (x < 0.0 || x > 1.0) return 0.0; // Error
            if (x === 0.0 || x === 1.0) return 0.0; // Limits
            // Use log gamma for large numbers
            const bt = (x === 0.0 || x === 1.0) ? 0.0 :
                Math.exp(gammln(a + b) - gammln(a) - gammln(b) + a * Math.log(x) + b * Math.log(1.0 - x));
            if (x < (a + 1.0) / (a + b + 2.0))
                return bt * betacf(a, b, x) / a;
            else
                return 1.0 - bt * betacf(b, a, 1.0 - x) / b;
        }

        function betacf(a, b, x) {
            const MAXIT = 100; const EPS = 3.0e-7; const FPMIN = 1.0e-30;
            let qab = a + b; let qap = a + 1.0; let qam = a - 1.0;
            let c = 1.0; let d = 1.0 - qab * x / qap;
            if (Math.abs(d) < FPMIN) d = FPMIN;
            d = 1.0 / d; let h = d;
            for (let m = 1; m <= MAXIT; m++) {
                let m2 = 2 * m;
                let aa = m * (b - m) * x / ((qam + m2) * (a + m2));
                d = 1.0 + aa * d;
                if (Math.abs(d) < FPMIN) d = FPMIN;
                c = 1.0 + aa / c;
                if (Math.abs(c) < FPMIN) c = FPMIN;
                d = 1.0 / d;
                h *= d * c;
                aa = -(a + m) * (qab + m) * x / ((a + m2) * (qap + m2));
                d = 1.0 + aa * d;
                if (Math.abs(d) < FPMIN) d = FPMIN;
                c = 1.0 + aa / c;
                if (Math.abs(c) < FPMIN) c = FPMIN;
                d = 1.0 / d;
                let del = d * c;
                h *= del;
                if (Math.abs(del - 1.0) < EPS) break;
            }
            return h;
        }

        function gammln(xx) {
            let x, y, tmp, ser;
            const cof = [76.18009172947146, -86.50532032941677, 24.01409824083091, -1.231739572450155, 0.1208650973866179e-2, -0.5395239384953e-5];
            y = x = xx;
            tmp = x + 5.5;
            tmp -= (x + 0.5) * Math.log(tmp);
            ser = 1.000000000190015;
            for (let j = 0; j <= 5; j++) ser += cof[j] / ++y;
            return -tmp + Math.log(2.5066282746310005 * ser / x);
        }

        // --- 3. ANALYSIS LOGIC ---

        // Assign Groups
        rawData.forEach(d => {
            const highTDS = d.tds > TDS_MEDIAN;
            const highORP = d.orp >= ORP_MEDIAN; // Using >= for high based on prompt logic
            if (!highTDS && !highORP) d.group = 'G1';
            else if (!highTDS && highORP) d.group = 'G2';
            else if (highTDS && !highORP) d.group = 'G3';
            else d.group = 'G4';
            
            d.factorTDS = highTDS ? 'High' : 'Low';
            d.factorORP = highORP ? 'High' : 'Low';
        });

        // Calculate Stats
        const groups = ['G1', 'G2', 'G3', 'G4'];
        const groupCounts = {};
        groups.forEach(g => groupCounts[g] = rawData.filter(d => d.group === g).length);

        // ANOVA Calculation (Type III SS simplified for 2x2)
        // Since implementing full GLM Type III in JS is heavy, we use the method of unweighted means 
        // or regression approach if possible. For this demo, we use a standard 2-way ANOVA calculation
        // assuming independence.
        
        function calculateANOVA(param) {
            const values = rawData.map(d => d[param]);
            const grandMean = mean(values);
            
            // Factors
            const levelsTDS = ['Low', 'High'];
            const levelsORP = ['Low', 'High'];
            
            // Cell Means & Counts
            let cellMeans = {};
            let cellCounts = {};
            let harmonicMeanN = 0;
            let sumReciprocals = 0;

            levelsTDS.forEach(t => {
                levelsORP.forEach(o => {
                    const subset = rawData.filter(d => d.factorTDS === t && d.factorORP === o);
                    const key = t + '-' + o;
                    cellMeans[key] = subset.length > 0 ? mean(subset.map(d => d[param])) : 0;
                    cellCounts[key] = subset.length;
                    if(subset.length > 0) sumReciprocals += 1/subset.length;
                });
            });
            harmonicMeanN = 4 / sumReciprocals; // Harmonic mean for unbalanced designs approximation

            // Main Effects (using unweighted means for Type III approximation in unbalanced)
            // Marginal Means
            const meanLowTDS = (cellMeans['Low-Low'] + cellMeans['Low-High']) / 2;
            const meanHighTDS = (cellMeans['High-Low'] + cellMeans['High-High']) / 2;
            const meanLowORP = (cellMeans['Low-Low'] + cellMeans['High-Low']) / 2;
            const meanHighORP = (cellMeans['Low-High'] + cellMeans['High-High']) / 2;
            const meanGrandUnweighted = (meanLowTDS + meanHighTDS) / 2;

            // SS Effects (Approximation for Type III)
            // SS_A = n_h * sum((Mean_Ai - GrandMean)^2)
            // For unbalanced, we use harmonic mean of n
            const ssTDS = harmonicMeanN * 2 * (Math.pow(meanLowTDS - meanGrandUnweighted, 2) + Math.pow(meanHighTDS - meanGrandUnweighted, 2));
            const ssORP = harmonicMeanN * 2 * (Math.pow(meanLowORP - meanGrandUnweighted, 2) + Math.pow(meanHighORP - meanGrandUnweighted, 2));
            
            // Interaction
            // SS_AB = n_h * sum((Mean_ij - Mean_Ai - Mean_Bj + GrandMean)^2)
            let ssInt = 0;
            levelsTDS.forEach(t => {
                levelsORP.forEach(o => {
                    const mT = t === 'Low' ? meanLowTDS : meanHighTDS;
                    const mO = o === 'Low' ? meanLowORP : meanHighORP;
                    const cellM = cellMeans[t+'-'+o];
                    ssInt += Math.pow(cellM - mT - mO + meanGrandUnweighted, 2);
                });
            });
            ssInt *= harmonicMeanN;

            // SS Error (Within)
            let ssError = 0;
            rawData.forEach(d => {
                const key = d.factorTDS + '-' + d.factorORP;
                ssError += Math.pow(d[param] - cellMeans[key], 2);
            });

            // DF
            const dfTDS = 1;
            const dfORP = 1;
            const dfInt = 1;
            const dfError = rawData.length - 4;

            // MS
            const msTDS = ssTDS / dfTDS;
            const msORP = ssORP / dfORP;
            const msInt = ssInt / dfInt;
            const msError = ssError / dfError;

            // F
            const fTDS = msTDS / msError;
            const fORP = msORP / msError;
            const fInt = msInt / msError;

            // P-values
            const pTDS = fDist(fTDS, dfTDS, dfError);
            const pORP = fDist(fORP, dfORP, dfError);
            const pInt = fDist(fInt, dfInt, dfError);

            // Effect Size (Partial Eta Squared)
            const etaTDS = ssTDS / (ssTDS + ssError);
            const etaORP = ssORP / (ssORP + ssError);
            const etaInt = ssInt / (ssInt + ssError);

            return {
                param,
                tds: { f: fTDS, p: pTDS, eta: etaTDS },
                orp: { f: fORP, p: pORP, eta: etaORP },
                int: { f: fInt, p: pInt, eta: etaInt },
                means: cellMeans,
                se: Math.sqrt(msError / harmonicMeanN) // Approx SE for plots
            };
        }

        const anovaResults = params.map(p => calculateANOVA(p));

        // --- 4. RENDERING FUNCTIONS ---

        // Update Counts
        document.getElementById('count-g1').innerText = groupCounts['G1'];
        document.getElementById('count-g2').innerText = groupCounts['G2'];
        document.getElementById('count-g3').innerText = groupCounts['G3'];
        document.getElementById('count-g4').innerText = groupCounts['G4'];

        // Render Table
        const tableBody = document.getElementById('anova-table-body');
        const getStars = (p) => {
            if (p < 0.001) return '<span class="text-red-600 font-bold">***</span>';
            if (p < 0.01) return '<span class="text-orange-500 font-bold">**</span>';
            if (p < 0.05) return '<span class="text-yellow-600 font-bold">*</span>';
            return '<span class="text-gray-400">ns</span>';
        };
        const fmt = (n) => n.toFixed(2);
        const fmtP = (n) => n < 0.001 ? '<0.001' : n.toFixed(3);

        anovaResults.forEach(res => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${paramLabels[res.param]}</td>
                <td class="px-6 py-4 whitespace-nowrap text-center bg-blue-50/30">
                    <div class="text-sm font-bold text-gray-800">${fmt(res.tds.f)} ${getStars(res.tds.p)}</div>
                    <div class="text-xs text-gray-500">p=${fmtP(res.tds.p)}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center bg-orange-50/30">
                    <div class="text-sm font-bold text-gray-800">${fmt(res.orp.f)} ${getStars(res.orp.p)}</div>
                    <div class="text-xs text-gray-500">p=${fmtP(res.orp.p)}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center bg-green-50/30">
                    <div class="text-sm font-bold text-gray-800">${fmt(res.int.f)} ${getStars(res.int.p)}</div>
                    <div class="text-xs text-gray-500">p=${fmtP(res.int.p)}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <div class="text-sm text-gray-700">${fmt(res.int.eta)}</div>
                </td>
            `;
            tableBody.appendChild(row);
        });

        // Populate Selects
        const selects = ['interaction-param-select', 'means-param-select'];
        selects.forEach(id => {
            const el = document.getElementById(id);
            params.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p;
                opt.text = paramLabels[p];
                el.appendChild(opt);
            });
        });

        // --- 5. CHARTS ---

        // Colors
        const colCluster = { 'I': '#3b82f6', 'II': '#ef4444', 'III': '#10b981' };
        const colGroup = { 'G1': 'rgba(59, 130, 246, 0.1)', 'G2': 'rgba(249, 115, 22, 0.1)', 'G3': 'rgba(79, 70, 229, 0.1)', 'G4': 'rgba(239, 68, 68, 0.1)' };

        // 1. Scatter Chart
        const ctxScatter = document.getElementById('scatterChart').getContext('2d');
        const scatterData = rawData.map(d => ({
            x: d.tds,
            y: d.orp,
            cluster: d.Cluster,
            id: d.id
        }));

        new Chart(ctxScatter, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Samples',
                    data: scatterData,
                    backgroundColor: scatterData.map(d => colCluster[d.cluster]),
                    pointRadius: 6,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'logarithmic',
                        title: { display: true, text: 'TDS (mg/L) - Log Scale' },
                        grid: { color: '#e5e7eb' }
                    },
                    y: {
                        title: { display: true, text: 'ORP (mV)' },
                        grid: { color: '#e5e7eb' }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `${ctx.raw.id}: TDS ${ctx.raw.x}, ORP ${ctx.raw.y} (${ctx.raw.cluster})`
                        }
                    },
                    annotation: {
                        // Chart.js annotation plugin not loaded, using custom draw if needed or just grid lines
                        // Simulating quadrants with background color requires plugin or complex canvas manipulation.
                        // We will rely on the grid lines for medians visually.
                    }
                }
            },
            plugins: [{
                id: 'quadrants',
                beforeDraw: (chart) => {
                    const {ctx, chartArea: {left, top, right, bottom}, scales: {x, y}} = chart;
                    const midX = x.getPixelForValue(TDS_MEDIAN);
                    const midY = y.getPixelForValue(ORP_MEDIAN);

                    ctx.save();
                    // G1: Low TDS, Low ORP
                    ctx.fillStyle = colGroup['G1'];
                    ctx.fillRect(left, midY, midX - left, bottom - midY);
                    // G2: Low TDS, High ORP
                    ctx.fillStyle = colGroup['G2'];
                    ctx.fillRect(left, top, midX - left, midY - top);
                    // G3: High TDS, Low ORP
                    ctx.fillStyle = colGroup['G3'];
                    ctx.fillRect(midX, midY, right - midX, bottom - midY);
                    // G4: High TDS, High ORP
                    ctx.fillStyle = colGroup['G4'];
                    ctx.fillRect(midX, top, right - midX, midY - top);
                    
                    // Lines
                    ctx.strokeStyle = '#6b7280';
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(midX, top); ctx.lineTo(midX, bottom);
                    ctx.moveTo(left, midY); ctx.lineTo(right, midY);
                    ctx.stroke();
                    ctx.restore();
                }
            }]
        });

        // 2. Interaction Plot
        let interactionChart;
        function updateInteractionPlot() {
            const param = document.getElementById('interaction-param-select').value;
            const res = anovaResults.find(r => r.param === param);
            const ctx = document.getElementById('interactionChart').getContext('2d');
            
            if(interactionChart) interactionChart.destroy();

            const dataLowORP = [res.means['Low-Low'], res.means['High-Low']];
            const dataHighORP = [res.means['Low-High'], res.means['High-High']];
            const err = res.se;

            interactionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Low TDS', 'High TDS'],
                    datasets: [
                        {
                            label: 'Low ORP',
                            data: dataLowORP,
                            borderColor: '#3b82f6',
                            backgroundColor: '#3b82f6',
                            tension: 0,
                            pointRadius: 6
                        },
                        {
                            label: 'High ORP',
                            data: dataHighORP,
                            borderColor: '#f97316',
                            backgroundColor: '#f97316',
                            tension: 0,
                            pointRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { title: { display: true, text: paramLabels[param] } }
                    },
                    plugins: {
                        title: { display: true, text: `Interaction: TDS × ORP on ${paramLabels[param]}` }
                    }
                }
            });
        }
        updateInteractionPlot();

        // 3. Radar Chart
        const ctxRadar = document.getElementById('radarChart').getContext('2d');
        new Chart(ctxRadar, {
            type: 'radar',
            data: {
                labels: params.map(p => paramLabels[p]),
                datasets: [
                    {
                        label: 'TDS Effect (η²)',
                        data: anovaResults.map(r => r.tds.eta),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                    },
                    {
                        label: 'ORP Effect (η²)',
                        data: anovaResults.map(r => r.orp.eta),
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.2)',
                    },
                    {
                        label: 'Interaction (η²)',
                        data: anovaResults.map(r => r.int.eta),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 1.0
                    }
                }
            }
        });

        // 4. Heatmap (HTML Table Construction)
        const heatmapContainer = document.getElementById('heatmap-container');
        let hmHTML = `<table class="w-full border-collapse"><thead><tr><th class="p-2"></th><th class="p-2">TDS</th><th class="p-2">ORP</th><th class="p-2">Interaction</th></tr></thead><tbody>`;
        
        // Helper for color scale
        const getColor = (f) => {
            // Simple linear scale for F-value visualization 0 to 20+
            const maxF = 20;
            const intensity = Math.min(f / maxF, 1);
            // White to Red
            const r = 255;
            const g = Math.round(255 * (1 - intensity));
            const b = Math.round(255 * (1 - intensity));
            return `rgb(${r},${g},${b})`;
        };

        anovaResults.forEach(r => {
            hmHTML += `<tr>
                <td class="font-medium text-sm p-2 text-right">${paramLabels[r.param]}</td>
                <td class="p-2 text-center border border-white heatmap-cell" style="background-color: ${getColor(r.tds.f)}">
                    <div class="text-xs font-bold">${r.tds.f.toFixed(1)}</div>
                    <div class="text-[10px]">${getStars(r.tds.p).replace(/<[^>]*>/g, r.tds.p < 0.05 ? '*' : '')}</div>
                </td>
                <td class="p-2 text-center border border-white heatmap-cell" style="background-color: ${getColor(r.orp.f)}">
                    <div class="text-xs font-bold">${r.orp.f.toFixed(1)}</div>
                    <div class="text-[10px]">${getStars(r.orp.p).replace(/<[^>]*>/g, r.orp.p < 0.05 ? '*' : '')}</div>
                </td>
                <td class="p-2 text-center border border-white heatmap-cell" style="background-color: ${getColor(r.int.f)}">
                    <div class="text-xs font-bold">${r.int.f.toFixed(1)}</div>
                    <div class="text-[10px]">${getStars(r.int.p).replace(/<[^>]*>/g, r.int.p < 0.05 ? '*' : '')}</div>
                </td>
            </tr>`;
        });
        hmHTML += `</tbody></table>`;
        heatmapContainer.innerHTML = hmHTML;

        // 5. Means Chart
        let meansChart;
        function updateMeansPlot() {
            const param = document.getElementById('means-param-select').value;
            const ctx = document.getElementById('meansChart').getContext('2d');
            
            // Calculate means per group G1-G4
            const groupMeans = groups.map(g => {
                const subset = rawData.filter(d => d.group === g).map(d => d[param]);
                return subset.length ? mean(subset) : 0;
            });
            
            // Calculate SE
            const groupSE = groups.map(g => {
                const subset = rawData.filter(d => d.group === g).map(d => d[param]);
                return subset.length > 1 ? se(subset) : 0;
            });

            if(meansChart) meansChart.destroy();

            meansChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['G1 (L-L)', 'G2 (L-H)', 'G3 (H-L)', 'G4 (H-H)'],
                    datasets: [{
                        label: `Mean ${paramLabels[param]}`,
                        data: groupMeans,
                        backgroundColor: [colGroup['G1'].replace('0.1', '0.6'), colGroup['G2'].replace('0.1', '0.6'), colGroup['G3'].replace('0.1', '0.6'), colGroup['G4'].replace('0.1', '0.6')],
                        borderColor: ['#3b82f6', '#f97316', '#4f46e5', '#ef4444'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false, title: { display: true, text: paramLabels[param] } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                afterLabel: (ctx) => `SE: ±${groupSE[ctx.dataIndex].toFixed(3)}`
                            }
                        }
                    }
                }
            });
        }
        updateMeansPlot();


        // --- 6. STATS DETAILS & CODE ---

        // Populate Stats Details
        const statsContent = document.getElementById('stats-details-content');
        let statsHTML = '';
        
        anovaResults.forEach(r => {
            // Normality Check (Simplified: Skewness)
            const vals = rawData.map(d => d[r.param]);
            const m = mean(vals);
            const s = sd(vals);
            const skew = mean(vals.map(v => Math.pow((v-m)/s, 3)));
            const isNormal = Math.abs(skew) < 1; // Rough rule of thumb

            // Homogeneity (Variance ratio)
            const vars = groups.map(g => {
                const sub = rawData.filter(d => d.group === g).map(d => d[r.param]);
                return sub.length > 1 ? variance(sub) : 0;
            }).filter(v => v > 0);
            const maxVar = Math.max(...vars);
            const minVar = Math.min(...vars);
            const ratio = maxVar / minVar;
            const isHomogeneous = ratio < 4; // Rough rule

            statsHTML += `
                <div class="border-b pb-2 mb-2">
                    <h4 class="font-bold text-sm text-gray-800">${paramLabels[r.param]}</h4>
                    <div class="grid grid-cols-2 gap-2 text-xs mt-1">
                        <div>
                            <span class="text-gray-500">Normality (Skew):</span> 
                            <span class="${isNormal ? 'text-green-600' : 'text-red-500'}">${skew.toFixed(2)} (${isNormal ? 'OK' : 'Skewed'})</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Homogeneity (Var Ratio):</span> 
                            <span class="${isHomogeneous ? 'text-green-600' : 'text-red-500'}">${ratio.toFixed(2)} (${isHomogeneous ? 'OK' : 'Het.'})</span>
                        </div>
                    </div>
                    ${r.int.p < 0.05 ? `
                    <div class="mt-1 text-xs bg-yellow-50 p-1 rounded text-yellow-800">
                        <strong>Significant Interaction:</strong> Simple main effects analysis recommended.
                    </div>` : ''}
                </div>
            `;
        });
        statsContent.innerHTML = statsHTML;

        // Code Generation
        const codePython = `import pandas as pd
import statsmodels.api as sm
from statsmodels.formula.api import ols

# Load Data
df = pd.read_csv('groundwater_dom.csv')

# Define Groups
median_tds = 693.4
median_orp = 201.1
df['TDS_Group'] = df['TDS'].apply(lambda x: 'High' if x > median_tds else 'Low')
df['ORP_Group'] = df['ORP'].apply(lambda x: 'High' if x >= median_orp else 'Low')

# List of parameters
params = ['HIX', 'FI', 'SUVA254', 'H_C', 'O_C', 'AImod', 'DBE', 'NOSC']

for p in params:
    print(f"--- ANOVA for {p} ---")
    # Type III Sum of Squares
    model = ols(f'{p} ~ C(TDS_Group) * C(ORP_Group)', data=df).fit()
    table = sm.stats.anova_lm(model, typ=3)
    print(table)
    print("\\n")
`;

        const codeR = `library(car)

# Load Data
df <- read.csv('groundwater_dom.csv')

# Define Groups
median_tds <- 693.4
median_orp <- 201.1
df$TDS_Group <- factor(ifelse(df$TDS > median_tds, 'High', 'Low'))
df$ORP_Group <- factor(ifelse(df$ORP >= median_orp, 'High', 'Low'))

# Parameters
params <- c('HIX', 'FI', 'SUVA254', 'H_C', 'O_C', 'AImod', 'DBE', 'NOSC')

for (p in params) {
  cat(paste("--- ANOVA for", p, "---\\n"))
  # Type III Sum of Squares
  f <- as.formula(paste(p, "~ TDS_Group * ORP_Group"))
  model <- lm(f, data=df, contrasts=list(TDS_Group=contr.sum, ORP_Group=contr.sum))
  print(Anova(model, type="III"))
  cat("\\n")
}
`;

        const codeDisplay = document.getElementById('code-display');
        let currentCode = codePython;
        codeDisplay.innerText = currentCode;

        function switchCode(lang) {
            if(lang === 'python') {
                currentCode = codePython;
                document.getElementById('btn-code-python').classList.add('bg-white', 'shadow', 'text-blue-600');
                document.getElementById('btn-code-python').classList.remove('text-gray-500');
                document.getElementById('btn-code-r').classList.remove('bg-white', 'shadow', 'text-blue-600');
                document.getElementById('btn-code-r').classList.add('text-gray-500');
            } else {
                currentCode = codeR;
                document.getElementById('btn-code-r').classList.add('bg-white', 'shadow', 'text-blue-600');
                document.getElementById('btn-code-r').classList.remove('text-gray-500');
                document.getElementById('btn-code-python').classList.remove('bg-white', 'shadow', 'text-blue-600');
                document.getElementById('btn-code-python').classList.add('text-gray-500');
            }
            codeDisplay.innerText = currentCode;
        }

        function copyCode() {
            navigator.clipboard.writeText(currentCode).then(() => {
                alert('Code copied to clipboard!');
            });
        }

        // --- 7. UTILITIES ---

        function switchTab(tabId) {
            // Hide all
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(el => {
                el.classList.remove('tab-active', 'border-b-2');
                el.classList.add('tab-inactive', 'border-transparent');
            });

            // Show target
            document.getElementById(tabId).classList.remove('hidden');
            const btn = document.getElementById('btn-' + tabId);
            btn.classList.remove('tab-inactive', 'border-transparent');
            btn.classList.add('tab-active', 'border-b-2');
        }

        function exportCSV() {
            let csv = 'Parameter,F_TDS,p_TDS,F_ORP,p_ORP,F_Int,p_Int,Eta_Int\n';
            anovaResults.forEach(r => {
                csv += `${r.param},${r.tds.f},${r.tds.p},${r.orp.f},${r.orp.p},${r.int.f},${r.int.p},${r.int.eta}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'anova_results.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function exportReport() {
            // Simple markdown generation
            let md = `# Groundwater DOM Analysis Report\n\n`;
            md += `## Methodology\nTwo-way ANOVA (Type III SS) based on TDS (Median ${TDS_MEDIAN}) and ORP (Median ${ORP_MEDIAN}).\n\n`;
            md += `## Significant Findings (Interaction p < 0.05)\n`;
            anovaResults.filter(r => r.int.p < 0.05).forEach(r => {
                md += `- **${paramLabels[r.param]}**: Interaction F=${r.int.f.toFixed(2)}, p=${r.int.p.toFixed(4)}\n`;
            });
            
            const blob = new Blob([md], { type: 'text/markdown' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'analysis_report.md');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

    </script>
</body>
</html>
